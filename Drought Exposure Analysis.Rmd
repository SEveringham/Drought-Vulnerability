---
title: "Drought Exposure Analysis"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
date: "2024-05-16"
---

```{r, include=FALSE}
options(width = 60)
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})
```

## Libraries required
```{r, message = F, warning = F}
library(tidyverse)
library(ggplot2)
library(Hmisc)
library(ggridges)
library(ggchicklet)
```

## Read in data
```{r}
droughtdata <- read.csv("Data/Data Used in Analyses/droughtdataforanalyses.csv")
```

## Sourcing Functions
```{r}
source("Functions/Functions.R")
```


## Figures 

To determine the exposure of drought to species listed as threatened on the IUCN redlist

We are starting off with 9746 species because we have previously filtered out aquatic species that aren't biologically impacted by terrestrial drought

### Robustness of drought data

Firstly Looking at the robustness of drought data which species' extent of occurrences (EOO)

Doing this for both IPCC scenarios SSP 2-4.5 (245 in data) and SSP 5-8.5 (585 in data)

```{r,figures-side, fig.show="hold", out.width="50%", message = F}
robustnessofdroughtprojection245 <- ggplot(data=droughtdata, aes(x =duration_245_proportion_non_robust.x, fill = "#53619E")) +
  geom_histogram(colour = "grey40", bins = 100) +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.15,
    y=8000,
  size = 10) +
  theme_classic(base_size =15) +
  labs(y = "Count of Species (log10 transformed)", x = "Proportion of a species' extent of occurrence that is a non-robust area \n (i.e. DOESN'T fall into robust drought projections pixel)") +
  scale_fill_manual(values =  "#53619E")+
  scale_y_continuous(trans = "log10") +
  guides(fill="none")
  
plot(robustnessofdroughtprojection245)

#quick count of species we can't include for scenario 245
sum(droughtdata$duration_245_proportion_non_robust.x == 1)
#5213 species we cannot use!

robustnessofdroughtprojection585 <- ggplot(data=droughtdata, aes(x =duration_585_proportion_non_robust.x,fill = "#53619E")) +
  geom_histogram(colour = "grey40", bins = 100) +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.15,
    y=8000,
    size = 10
  ) +
  theme_classic(base_size = 15) +
  labs(y = "", x = "Proportion of a species' extent of occurrence that is a non-robust area \n (i.e. DOESN'T fall into robust drought projections pixel)") +
  scale_y_continuous(trans = "log10") +
  scale_fill_manual(values =  "#53619E")+
  guides(fill="none")
  
  
plot(robustnessofdroughtprojection585)


#quick count of species we can't include for scenario 585
sum(droughtdata$duration_585_proportion_non_robust.x == 1)
#3635 species we cannot use for scenario SSp 5-8.5

#quick count of how many species we can't use altoghter
sum(droughtdata$duration_245_proportion_non_robust.x == 1 &
      droughtdata$duration_585_proportion_non_robust.x == 1)
#3465 species have no range in robust drought projection areas for either scenario

#remove these species where there is no range at all in robust areas
droughtdatarobust <- droughtdata %>%
  filter(!(droughtdata$duration_245_proportion_non_robust.x == 1 &
      droughtdata$duration_585_proportion_non_robust.x == 1))
```

Now we are left with 6281 species with extents of occurrence in at least a small proportion of their range in a robust drought projected area for either scenario

With these species let's have a look at their proportion of distribution in future drought projection changes.

### Drought Duration

#### Barplots and Violin plots

First we are going to have a look at the distribution of the number of species i.e. the percentage/proportion of species whose ranges proportionately fall into areas that will increase in drought duration or decrease in drought duration (or show no change - 0) into the future

First create a barplot for the overall trend to show the bounded data, then pull the the 1s and 0s to have normally spread looking violin plots

```{r, max.height='200px', fig.show="hold", out.width="50%", message = F, warning = F}
#create a little dataframe with indicators for what scenario each species falls into - can then use these for totals later  

#SSP 2-4.5
SpeciesScenariosDuration245 <- droughtdatarobust %>%
  filter(!duration_245_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(duration_245_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(duration_245_proportion_positive_value.x > 0 & duration_245_proportion_positive_value.x < 1 & duration_245_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(duration_245_proportion_positive_value.x > 0 & duration_245_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(duration_245_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(duration_245_proportion_negative_value.x > 0 & duration_245_proportion_negative_value.x < 1 & duration_245_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountDuration245 <- SpeciesScenariosDuration245 %>%
  group_by(Scenario) %>%
  summarise(length(duration_245_proportion_non_robust.x)) %>%
  mutate(Metric = "Duration") %>%
  rename(NumberofSpecies = `length(duration_245_proportion_non_robust.x)`)

#create barplot
StatsPlot245 <- SpeciesScenariosCountDuration245 %>%
  ggplot(aes(x = Metric, y = log10(NumberofSpecies +1), fill = Scenario)) +
  geom_bar(position="stack", stat="identity", alpha = 0.9, colour="black") +
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "white", "#60c659", "#326b2e")) +
  theme_classic() +
  scale_x_discrete(limits=rev) +
  coord_flip() +
  guides(fill = "none") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=1.5,
    y=2,
    size = 10
  ) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
StatsPlot245

#SSP 5-8.5
SpeciesScenariosDuration585 <- droughtdatarobust %>%
  filter(!duration_585_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(duration_585_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(duration_585_proportion_positive_value.x > 0 & duration_585_proportion_positive_value.x < 1 & duration_585_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(duration_585_proportion_positive_value.x > 0 & duration_585_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(duration_585_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(duration_585_proportion_negative_value.x > 0 & duration_585_proportion_negative_value.x < 1 & duration_585_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountDuration585 <- SpeciesScenariosDuration585 %>%
  group_by(Scenario) %>%
  summarise(length(duration_585_proportion_non_robust.x)) %>%
  mutate(Metric = "Duration") %>%
  rename(NumberofSpecies = `length(duration_585_proportion_non_robust.x)`)

#create barplot
StatsPlot585 <- SpeciesScenariosCountDuration585 %>%
  ggplot(aes(x = Metric, y = log10(NumberofSpecies +1), fill = Scenario)) +
  geom_bar(position="stack", stat="identity", alpha = 0.9, colour="black") +
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "white", "#60c659", "#326b2e")) +
  theme_classic() +
  scale_x_discrete(limits=rev) +
  coord_flip() +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=1.5,
    y=2.5,
    size = 10) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
StatsPlot585

#now box and scatter plots

#scenario SPP 2-4.5
proportiondroughtdurationincreasingordecreasing245 <- SpeciesScenariosDuration245 %>%
  filter(!Scenario == " increaseAll") %>%
  filter(!Scenario == "decreaseAll") %>%
  select(scientificName, duration_245_proportion_positive_value.x, duration_245_proportion_negative_value.x) %>%
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  mutate(proportion = ifelse(proportion == 0, NA, proportion)) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = positiveornegative)) +
  geom_violin(width = 1.5) +
  scale_x_discrete(breaks=c("duration_245_proportion_positive_value.x","duration_245_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "grey30") +
    scale_fill_manual(name = "positiveornegative", values = c("#60c659", "#FC7F3F")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "Proportion of each species' range that \n falls into drought duration change \n (log10 trans.)", x = "")

proportiondroughtdurationincreasingordecreasing245

#scenario SPP 5 - 8.5
proportiondroughtdurationincreasingordecreasing585 <- SpeciesScenariosDuration585 %>%
  filter(!Scenario == " increaseAll") %>%
  filter(!Scenario == "decreaseAll") %>%
  select(scientificName, duration_585_proportion_positive_value.x, duration_585_proportion_negative_value.x) %>%
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  mutate(proportion = ifelse(proportion == 0, NA, proportion)) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = positiveornegative)) +
  geom_violin(width = 1.5) +
  scale_x_discrete(breaks=c("duration_585_proportion_positive_value.x","duration_585_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "grey30") +
    scale_fill_manual(name = "positiveornegative", values = c("#60c659", "#FC7F3F")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(x = "") +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank())
proportiondroughtdurationincreasingordecreasing585
```
Some key stats from above figures:

For SSP 2-4.5

- 92.3% of species (4187 species out of 4533) have some part of their range that falls into at least one area of an increase in drought duration
- 40% of species (1807 out of 4533) have their entire range falling into areas that increase in drought duration
- 14% of species (617 out of 4533) have some part of their range that falls into at least one area of a decrease in drought duration
- Only one singular species (<1%) has it’s entire range falling into regions with decreases in drought duration
- On average, 57% of any given species’ range will fall into increases in drought duration
Whereas on average <1% of any given species’ range will fall into an area that decreases in drought duration

<br>

For SSP 5-8.5 (similar stats to above scenario - they just get a tiny bit worse…)
<br>

- 95.0% of species (5808 species out of 6111) have some part of their range that falls into at least one area of an increase in drought duration
- 54% of species (3321 out of 6111) have their entire range falling into areas that increase in drought duration
- 11% of species (679 out of 6111) have some part of their range that falls into at least one area of a decrease in drought duration
- Only three species (<1%) have their entire range falling into regions with decreases in drought duration
- On average, 42% of any given species’ range will fall into increases in drought duration
- Whereas on average <1% of any given species’ range will fall into an area that decreases in drought duration


Now same plots but with JUST threatened species (vulnerable, endangered, critically endangered) and comparing these groups

```{r,max.height='200px', fig.show="hold", out.width="50%", message = F, warning = F}
#scenario SPP 2-4.5
threatenedspeciesprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_245_proportion_positive_value.x, duration_245_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  filter(!proportion == 1) %>%
  filter(!proportion == 0) %>%
  ggplot(aes(x = positiveornegative, y = proportion), fill = category.x) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("duration_245_proportion_positive_value.x","duration_245_proportion_negative_value.x"), labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  labs(y = "Proportion of each species' range that \n falls into drought duration change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1,
    size = 10
  )
    
threatenedspeciesprop245

#scenario SPP 5-8.5
threatenedspeciesprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_585_proportion_positive_value.x, duration_585_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  filter(!proportion == 1) %>%
  filter(!proportion == 0) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
   scale_x_discrete(breaks=c("duration_585_proportion_positive_value.x","duration_585_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
    theme_classic(base_size = 15) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.9,
    y=1,
    size = 10
  )
threatenedspeciesprop585
```
Issue in the left figure - sorry! This is because there's less than two data points in the CR in scenario 2-4.5 that have a proportional decrease in drought duration.

&

These figures seem to indicate that there's no significant differences in drought duration changes between the threat levels 

Having a brief look now at some differences between ALL threatened species and all non-threatened species

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SSP 2-4.5
threatenedspeciesvsallprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_245_proportion_positive_value.x, duration_245_proportion_negative_value.x) %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(threatenedornot = if_else(.$category.x %in% c('CR','EN', 'VU'), "threatened", "not threatened")) %>%
  select(!category.x) %>%
  pivot_longer(!c(scientificName, threatenedornot), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = threatenedornot)) +
  geom_violin(aes(fill= threatenedornot), width = 1.3) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = threatenedornot),
    position=position_dodge(1.3),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "threatenedornot", values = c("#60c659", "#D52001")) +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("duration_245_proportion_positive_value.x","duration_245_proportion_negative_value.x"), labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  labs(y = "Proportion of each species' range that \n falls into drought duration change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=1,
    y=1,
    size = 10
  ) +
  guides(fill = "none")
  
threatenedspeciesvsallprop245

#scenario SSP 5-8.5
threatenedspeciesvsallprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_585_proportion_positive_value.x, duration_585_proportion_negative_value.x) %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(threatenedornot = if_else(.$category.x %in% c('CR','EN', 'VU'), "threatened", "not threatened")) %>%
  select(!category.x) %>%
  pivot_longer(!c(scientificName, threatenedornot), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = threatenedornot)) +
  geom_violin(aes(fill= threatenedornot), width = 1.3) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = threatenedornot),
    position=position_dodge(1.3),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "threatenedornot", values = c("#60c659", "#D52001")) +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("duration_585_proportion_positive_value.x","duration_585_proportion_negative_value.x"), labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=1,
    y=1,
    size = 10
  )
  
threatenedspeciesvsallprop585
```
Interestingly, when you look at these plots comparing overall threatened plants (VU, EN, CR) vs non-threatened (LC, NT) you see a slightly better outcome for the non-threatened species - would be a good idea to logistically regress this relationship?

#### Density plots of duration change

gives a bit more detail - not just a binary negative or positive as above. Could replace with box/violin/beeswarm/other plots in future 

```{r, fig.show="hold", out.width="50%", message = F, warning = F}
#scenario SPP 2-4.5
frequencydensity245 <- droughtdatarobust %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(category.x= if_else(.$category.x %in% c('CR','EN', 'VU'), category.x, "ynot threatened")) %>%
  ggplot(aes(x = frequency_245_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.9, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814", "#60c659" )) +
  guides(fill = "none") +
  xlab("Mean Drought frequency Change for each species under SSP 2-4.5 Projection (months)") +
  ylab("") +
  theme_ridges() +
  geom_vline(xintercept = 0, size =1.5, color = "black")
frequencydensity245

#scenario SSP 5-8.5
durationdensity585 <- droughtdatarobust %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(category.x= if_else(.$category.x %in% c('CR','EN', 'VU'), category.x, "ynot threatened")) %>%
  ggplot(aes(x = frequency_585_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.9, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814", "#60c659")) +
  guides(fill = "none") +
  xlab("Mean Drought Duration Change for each species under SSP 5-8.5 Projection (months)") +
  ylab("") +
  theme_ridges() +
  geom_vline(xintercept = 0, size =1.5, color = "black")

durationdensity585
```


### Drought Frequency

#### Barplots and Violin plots

First we are going to have a look at the distribution of the number of species i.e. the percentage/proportion of species whose ranges proportionately fall into areas that will increase in drought frequency or decrease in drought frequency (or show no change - 0) into the future

First create a barplot for the overall trend to show the bounded data, then pull the the 1s and 0s to have normally spread looking violin plots

```{r, max.height='200px', fig.show="hold", out.width="50%", message = F, warning = F}
#create a little dataframe with indicators for what scenario each species falls into - can then use these for totals later  

#SSP 2-4.5
SpeciesScenariosfrequency245 <- droughtdatarobust %>%
  filter(!frequency_245_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(frequency_245_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(frequency_245_proportion_positive_value.x > 0 & frequency_245_proportion_positive_value.x < 1 & frequency_245_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(frequency_245_proportion_positive_value.x > 0 & frequency_245_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(frequency_245_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(frequency_245_proportion_negative_value.x > 0 & frequency_245_proportion_negative_value.x < 1 & frequency_245_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountfrequency245 <- SpeciesScenariosfrequency245 %>%
  group_by(Scenario) %>%
  summarise(length(frequency_245_proportion_non_robust.x)) %>%
  mutate(Metric = "frequency") %>%
  rename(NumberofSpecies = `length(frequency_245_proportion_non_robust.x)`)

#create barplot
StatsPlot245 <- SpeciesScenariosCountfrequency245 %>%
  ggplot(aes(x = Metric, y = log10(NumberofSpecies +1), fill = Scenario)) +
  geom_bar(position="stack", stat="identity", alpha = 0.9, colour="black") +
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "white", "#60c659", "#326b2e")) +
  theme_classic() +
  scale_x_discrete(limits=rev) +
  coord_flip() +
  guides(fill = "none") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=1.5,
    y=2,
    size = 10
  ) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
StatsPlot245

#SSP 5-8.5
SpeciesScenariosfrequency585 <- droughtdatarobust %>%
  filter(!frequency_585_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(frequency_585_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(frequency_585_proportion_positive_value.x > 0 & frequency_585_proportion_positive_value.x < 1 & frequency_585_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(frequency_585_proportion_positive_value.x > 0 & frequency_585_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(frequency_585_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(frequency_585_proportion_negative_value.x > 0 & frequency_585_proportion_negative_value.x < 1 & frequency_585_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountfrequency585 <- SpeciesScenariosfrequency585 %>%
  group_by(Scenario) %>%
  summarise(length(frequency_585_proportion_non_robust.x)) %>%
  mutate(Metric = "frequency") %>%
  rename(NumberofSpecies = `length(frequency_585_proportion_non_robust.x)`)

#create barplot
StatsPlot585 <- SpeciesScenariosCountfrequency585 %>%
  ggplot(aes(x = Metric, y = log10(NumberofSpecies +1), fill = Scenario)) +
  geom_bar(position="stack", stat="identity", alpha = 0.9, colour="black") +
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "white", "#60c659", "#326b2e")) +
  theme_classic() +
  scale_x_discrete(limits=rev) +
  coord_flip() +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=1.5,
    y=2.5,
    size = 10) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
StatsPlot585

#now box and scatter plots

#scenario SPP 2-4.5
proportiondroughtfrequencyincreasingordecreasing245 <- SpeciesScenariosfrequency245 %>%
  filter(!Scenario == " increaseAll") %>%
  filter(!Scenario == "decreaseAll") %>%
  select(scientificName, frequency_245_proportion_positive_value.x, frequency_245_proportion_negative_value.x) %>%
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  mutate(proportion = ifelse(proportion == 0, NA, proportion)) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = positiveornegative)) +
  geom_violin(width = 1.5) +
  scale_x_discrete(breaks=c("frequency_245_proportion_positive_value.x","frequency_245_proportion_negative_value.x"),
        labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "grey30") +
    scale_fill_manual(name = "positiveornegative", values = c("#60c659", "#FC7F3F")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "Proportion of each species' range that \n falls into drought frequency change \n (log10 trans.)", x = "")

proportiondroughtfrequencyincreasingordecreasing245

#scenario SPP 5 - 8.5
proportiondroughtfrequencyincreasingordecreasing585 <- SpeciesScenariosfrequency585 %>%
  filter(!Scenario == " increaseAll") %>%
  filter(!Scenario == "decreaseAll") %>%
  select(scientificName, frequency_585_proportion_positive_value.x, frequency_585_proportion_negative_value.x) %>%
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  mutate(proportion = ifelse(proportion == 0, NA, proportion)) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = positiveornegative)) +
  geom_violin(width = 1.3) +
  scale_x_discrete(breaks=c("frequency_585_proportion_positive_value.x","frequency_585_proportion_negative_value.x"),
        labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "grey30") +
    scale_fill_manual(name = "positiveornegative", values = c("#60c659", "#FC7F3F")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(x = "") +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank())
proportiondroughtfrequencyincreasingordecreasing585
```


Some key stats from above figures:

For SSP 2-4.5

- 93.4% of species (4829 species out of 5168) have some part of their range that falls into at least one area of an increase in drought frequency
- 40% of species (2706 out of 5168) have their entire range falling into areas that increase in drought frequency
- 16% of species (807 out of 5168) have some part of their range that falls into at least one area of a decrease in drought frequency
- Only 9 species (<1%) has their entire range falling into regions with decreases in drought frequency
- On average, 50% of any given species’ range will fall into increases in drought frequency
Whereas on average <1% of any given species’ range will fall into an area that decreases in drought frequency

<br>
<br> 

For SSP 5-8.5 (similar stats to above scenario - they just get a tiny bit worse…)
<br>

- 93.7% of species (5419 species out of 5784) have some part of their range that falls into at least one area of an increase in drought duration
- 60% of species (3466 out of 5784) have their entire range falling into areas that increase in drought duration
- 16% of species (914 out of 5784) have some part of their range that falls into at least one area of a decrease in drought duration
- <1% (21 out of 5784 species) have their entire range falling into regions with decreases in drought duration
- On average, 42% of any given species’ range will fall into increases in drought duration
- Whereas on average <1% of any given species’ range will fall into an area that decreases in drought duration


Now same plots but with JUST threatened species (vulnerable, endangered, critically endangered) and comparing these groups
```{r,max.height='200px', fig.show="hold", out.width="50%", message = F, warning = F}
#scenario SPP 2-4.5
threatenedspeciesprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_245_proportion_positive_value.x, frequency_245_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  filter(!proportion == 1) %>%
  filter(!proportion == 0) %>%
  ggplot(aes(x = positiveornegative, y = proportion), fill = category.x) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("frequency_245_proportion_positive_value.x","frequency_245_proportion_negative_value.x"), labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  labs(y = "Proportion of each species' range that \n falls into drought frequency change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1,
    size = 10
  )
    
threatenedspeciesprop245

#scenario SPP 5-8.5
threatenedspeciesprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_585_proportion_positive_value.x, frequency_585_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  filter(!proportion == 1) %>%
  filter(!proportion == 0) %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
   scale_x_discrete(breaks=c("frequency_585_proportion_positive_value.x","frequency_585_proportion_negative_value.x"),
        labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
    theme_classic(base_size = 15) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.9,
    y=1,
    size = 10
  )
threatenedspeciesprop585
```

Having a brief look now at some differences between ALL threatened species and all non-threatened species

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SSP 2-4.5
threatenedspeciesvsallprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_245_proportion_positive_value.x, frequency_245_proportion_negative_value.x) %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(threatenedornot = if_else(.$category.x %in% c('CR','EN', 'VU'), "threatened", "not threatened")) %>%
  select(!category.x) %>%
  pivot_longer(!c(scientificName, threatenedornot), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = threatenedornot)) +
  geom_violin(aes(fill= threatenedornot), width = 1.6) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = threatenedornot),
    position=position_dodge(1.6),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "threatenedornot", values = c("#60c659", "#D52001")) +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("frequency_245_proportion_positive_value.x","frequency_245_proportion_negative_value.x"), labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  labs(y = "Proportion of each species' range that \n falls into drought frequency change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=1,
    y=1,
    size = 10
  ) +
  guides(fill = "none")
  
threatenedspeciesvsallprop245

#scenario SSP 5-8.5
threatenedspeciesvsallprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_585_proportion_positive_value.x, frequency_585_proportion_negative_value.x) %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(threatenedornot = if_else(.$category.x %in% c('CR','EN', 'VU'), "threatened", "not threatened")) %>%
  select(!category.x) %>%
  pivot_longer(!c(scientificName, threatenedornot), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = threatenedornot)) +
  geom_violin(aes(fill= threatenedornot), width = 1.3) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = threatenedornot),
    position=position_dodge(1.3),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "threatenedornot", values = c("#60c659", "#D52001")) +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("frequency_585_proportion_positive_value.x","frequency_585_proportion_negative_value.x"), labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=1,
    y=1,
    size = 10
  )
  
threatenedspeciesvsallprop585
```

#### Density plots of frequency change

gives a bit more detail - not just a binary negative or positive as above

```{r, fig.show="hold", out.width="50%", message = F, warning = F}
#scenario SPP 2-4.5
frequencydensity245 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = frequency_245_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 1, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Frequency Change for SSP 2-4.5 Projection (Events per 10y)") +
  ylab("Density of Species Mean Range Value") + 
  geom_vline(xintercept = 0, size =2, color = "skyblue3") +
  theme_ridges() +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=-0.4,
    y=3.7,
    size = 9
  )

frequencydensity245

#scenario SSP 5-8.5
frequencydensity585 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = frequency_585_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 0.5, alpha = 0.8, quantile_lines = T, quantile_fun = mean,
    jittered_points = TRUE,
    vline_size = 1, vline_color = "red",
    point_size = 0.2, point_alpha = 1,
    position = position_raincloud(adjust_vlines = TRUE)) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Frequency Change for SSP 5-8.5 Projection (Events per 10y)") +
  ylab("") +
  theme_ridges() +
  geom_vline(xintercept = 0, size =2, color = "skyblue3") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=-0.5,
    y=3.3,
    size = 9
  )

frequencydensity585
```
This second figure on the right here is to give an example of another way to represent the data - could be an option for the ridgeline plots

## Appendices

### COE poster figures

```{r}
#note all this data is all using SSP 2-4.5

#create a little dataframe with indicators for what scenario each species falls into - can then use these for totals later  

#for Duration
SpeciesScenariosDuration <- droughtdatarobust %>%
  filter(!duration_245_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(duration_245_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(duration_245_proportion_positive_value.x > 0 & duration_245_proportion_positive_value.x < 1 & duration_245_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(duration_245_proportion_positive_value.x > 0 & duration_245_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(duration_245_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(duration_245_proportion_negative_value.x > 0 & duration_245_proportion_negative_value.x < 1 & duration_245_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountDuration <- SpeciesScenariosDuration %>%
  group_by(Scenario) %>%
  summarise(length(duration_245_proportion_non_robust.x)) %>%
  mutate(Metric = "Duration") %>%
  rename(NumberofSpecies = `length(duration_245_proportion_non_robust.x)`)

#frequency
SpeciesScenariosFrequency <- droughtdatarobust %>%
  filter(!frequency_245_proportion_non_robust.x ==1) %>%
  mutate(Scenario = ifelse(frequency_245_proportion_positive_value.x == 1, " increaseAll",
                           ifelse(frequency_245_proportion_positive_value.x > 0 & frequency_245_proportion_positive_value.x < 1 & frequency_245_proportion_negative_value.x ==0, " increaseSome",
                                  ifelse(frequency_245_proportion_positive_value.x > 0 & frequency_245_proportion_negative_value.x > 0, "bothSome",
                                         ifelse(frequency_245_proportion_negative_value.x == 1, "decreaseAll",
                                                ifelse(frequency_245_proportion_negative_value.x > 0 & frequency_245_proportion_negative_value.x < 1 & frequency_245_proportion_positive_value.x == 0, "decrease Some", NA))))))

SpeciesScenariosCountFrequency <- SpeciesScenariosFrequency %>%
  group_by(Scenario) %>%
  summarise(length(frequency_245_proportion_non_robust.x)) %>%
  mutate(Metric = "Frequency") %>%
  rename(NumberofSpecies = `length(frequency_245_proportion_non_robust.x)`)

#merge duration and frequency together

ScenarioData <- rbind(SpeciesScenariosCountDuration, SpeciesScenariosCountFrequency)


#then create a bar chart? Or something similar

StatsPlot <- ScenarioData %>%
  ggplot(aes(x = Metric, y = log10(NumberofSpecies +1), fill = Scenario)) +
  geom_bar(position="stack", stat="identity", alpha = 0.9) +
  scale_fill_manual(values = c("#925600", "#f29715", "grey", "#b2deec", "#3d5fa9")) +
  theme_classic() +
  scale_x_discrete(limits=rev) +
  coord_flip()

ggsave(plot= StatsPlot, filename = "Outputs/OverallProportions.jpeg",  device = "jpeg", width = 10, height = 5)

```

Also creating quick figures of ridgeline plots for the poster 

```{r}
ridgelinethreatenedduration <- droughtdatarobust %>%
  filter(!category.x == 'DD' & !category.x == 'EW' & !category.x == 'EX' & !is.na(category.x)) %>%
  mutate(threatenedornot = if_else(.$category.x %in% c('CR','EN', 'VU'), " threatened", "not threatened")) %>%
  filter(threatenedornot == " threatened") %>%
  select(threatenedornot, duration_245_mean.x, frequency_245_mean.x) %>%
  pivot_longer(!threatenedornot, names_to = "durationfreq", values_to = "mean") %>%
  ggplot(aes(x = mean, y = durationfreq, fill = durationfreq)) +
  geom_density_ridges(scale = 4, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#f3a12c", "#925600")) +
  guides(fill = "none") +
  xlab("Mean Drought Duration Change (months)") +
  ylab("Density of Species Mean Value") + 
  geom_vline(xintercept = 0, size =1, color = "black") +
  theme_ridges() +
  theme(text=element_text(size=20))
  

ridgelinethreatenedduration

ggsave(plot= ridgelinethreatenedduration, filename = "Outputs/DurationPosterPlot.jpeg",  device = "jpeg", width = 10, height = 5)
```


