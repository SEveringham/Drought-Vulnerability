---
title: "Early Checks of Species lists"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
date: "2024-04-04"
---

## Libraries required

```{r, message = F}
library(tidyverse)
library(rredlist)
library(data.table)
library(reshape)
```

## Read in Data
```{r}
#data downloaded from the IUCN red list (https://www.iucnredlist.org/search) for all organisms in the "Plantae" Kingdom (~66,000 records) - plants
plantsonIUCN <- read.csv("Data/Raw Data/assessments.csv") %>%
  select(-language, -rationale, -threats, -population, -populationTrend, -range, -useTrade, -conservationActions, -yearLastSeen, -scopes)
taxonomyofplantsonIUCN <- read.csv("Data/Raw Data/taxonomy.csv")

#read in the data that we have spatial data for (and therefore drought data)
droughtdata <- read.csv("Data/Raw Data/drought_metrics_compile_20240326.csv") %>%
  dplyr::rename(scientificName = species_name)
```

## Join data
```{r, message = F}
fullDroughtIUCNdata <- left_join(plantsonIUCN, droughtdata) %>%
  mutate(DroughtDataAvailable = ifelse(is.na(duration_min), 'NotAvailable', 'Available'))
```


## Some interesting checks of the data 

### Quick look at how much our data represents
```{r}
howmuchdatawegot <- ggplot(data=fullDroughtIUCNdata, aes(DroughtDataAvailable, fill = DroughtDataAvailable)) +
  geom_bar() +
  scale_fill_manual(name = "DroughtDataAvailable", values = c("#7D5D3A", "#53619E")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Count of Species (log10 transformed)", x = "Drought Data Availability") +
  guides(fill="none")
plot(howmuchdatawegot)
```
<br>
<br>
<b>10,256 species have drought data out of 66,535 (15.4%)</b>

### Aquatic plants (and species' "system")
```{r, message = F, output = F}
#Marine Species with Droughtdata
sum(fullDroughtIUCNdata$DroughtDataAvailable == "Available" & fullDroughtIUCNdata$systems == "Marine", na.rm=TRUE)
#122 species

#Freshwater species with drought data
sum(fullDroughtIUCNdata$DroughtDataAvailable == "Available" & fullDroughtIUCNdata$systems == "Freshwater (=Inland waters)", na.rm=TRUE)
#769! a lot...

#Terrestrial/Freshwater species with drought data
sum(fullDroughtIUCNdata$DroughtDataAvailable == "Available" & fullDroughtIUCNdata$systems == "Terrestrial|Freshwater (=Inland waters)", na.rm=TRUE)
#921! a lot...

#Terrestrial/marine species with drought data
sum(fullDroughtIUCNdata$DroughtDataAvailable == "Available" & fullDroughtIUCNdata$systems == "Terrestrial|Marine", na.rm=TRUE)
#50

#Terrestrial/Freshwater/Marine species with drought data
sum(fullDroughtIUCNdata$DroughtDataAvailable == "Available" & fullDroughtIUCNdata$systems == "Terrestrial|Freshwater (=Inland waters)|Marine", na.rm=TRUE)
#22
```

Quick bargraphs
```{r}
speciessystems <- ggplot(data=fullDroughtIUCNdata, aes(systems, fill = DroughtDataAvailable)) +
  geom_bar(position= "dodge") +
  scale_fill_manual(name = "DroughtDataAvailable", values = c("#7D5D3A", "#53619E")) +
  scale_y_log10() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Count of Species (log10 transformed)", x = "Habitat Type (IUCN defined)") +
  guides(fill=guide_legend("Drought Data Availability"))

plot(speciessystems)
```


Aquatic plants problems: 
<br>

1) There are "freshwater" plants (769 species) that are included in the IUCN list AND our drought list - some of which ACTUALLY occupy water, some of which don't (grow along streams/rivers etc) and some of which can do both (juvenile in water and adult on land and vice versa) - what to do here as these plants may not actually be under "Drought" threat by the drought metrics we are using
<br>

2) Similar with "marine" plants (122 species) as above - but less are "both" or land dwelling near coast and more are actual sea grasses and other aquatic plants
<br>

3) Also related - there's these groups called "terrestrial/freshwater" (921 species) and "terrestrial/marine" (50 species) and all three (22 species) with a lot of species that have drought data! 
<br>

What to do for all of these aquatic plant cases - This is a total of 1884 species out of ~10,000... so a decent chunk. Do we look through one by one in their "habitat" description to select if they are aquatic or not? A lot of work! &#128128; &#128565; &#x1F635;


### Now checking out threat status

Quick bargraph
```{r}
redlistcategories <- fullDroughtIUCNdata %>%
  mutate(redlistCategory = factor(redlistCategory, c("Data Deficient", "Least Concern", "Lower Risk/least concern", "Lower Risk/conservation dependent", "Lower Risk/near threatened", "Near Threatened", "Vulnerable", "Endangered", "Critically Endangered", "Extinct in the Wild", "Extinct"))) %>%
  ggplot(aes(redlistCategory, fill = DroughtDataAvailable)) +
  geom_bar(position= "dodge") +
  scale_fill_manual(name = "DroughtDataAvailable", values = c("#7D5D3A", "#53619E")) +
  scale_y_log10() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Count of Species (log10 transformed)", x = "Red List Category") +
  guides(fill=guide_legend("Drought Data Availability"))

plot(redlistcategories)
```
<br>

Quick calculations of overall numbers
```{r}
#datadefinicent with drought
sum(fullDroughtIUCNdata$redlistCategory == "Data Deficient" & fullDroughtIUCNdata$DroughtDataAvailable == "Available")
#data deficient overall
sum(fullDroughtIUCNdata$redlistCategory == "Data Deficient")


#threatened (not including extinct or not threatened) with drought data
sum(fullDroughtIUCNdata$redlistCategory == "Critically Endangered" & fullDroughtIUCNdata$DroughtDataAvailable == "Available") + 
sum(fullDroughtIUCNdata$redlistCategory == "Endangered" & fullDroughtIUCNdata$DroughtDataAvailable == "Available") + 
sum(fullDroughtIUCNdata$redlistCategory == "Lower Risk/near threatened" & fullDroughtIUCNdata$DroughtDataAvailable == "Available") + 
sum(fullDroughtIUCNdata$redlistCategory == "Near Threatened" & fullDroughtIUCNdata$DroughtDataAvailable == "Available") + 
sum(fullDroughtIUCNdata$redlistCategory == "Vulnerable" & fullDroughtIUCNdata$DroughtDataAvailable == "Available")


#threatened (not including extinct or not threatened) overall
sum(fullDroughtIUCNdata$redlistCategory == "Critically Endangered") + 
sum(fullDroughtIUCNdata$redlistCategory == "Endangered") + 
sum(fullDroughtIUCNdata$redlistCategory == "Lower Risk/near threatened") + 
sum(fullDroughtIUCNdata$redlistCategory == "Near Threatened") + 
sum(fullDroughtIUCNdata$redlistCategory == "Vulnerable")
```

Data Deficient in redlist with drought data = 723 out of 10256 (7.0%)
Data deficient in general = 5371 out of 66,535 (8.1%)

Threatened in redlist with drought data = 4765 out of 10256 (46.5%)
Threatened in redlist in general = 30,310 out of 66,535 (45.6%)

### Having a look at realm (sort of a location or even a 'cosmopolitan-ness' proxy)

Quick bargraphs
```{r}
realms <- fullDroughtIUCNdata %>%
  mutate(Afrotropical = as.numeric(ifelse(grepl("Afrotropical", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Antarctic = as.numeric(ifelse(grepl("Antarctic", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Australasian = as.numeric(ifelse(grepl("Australasian", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Indomalayan = as.numeric(ifelse(grepl("Indomalayan", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Nearctic = as.numeric(ifelse(grepl("Nearctic", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Neotropical = as.numeric(ifelse(grepl("Neotropical", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Oceanian = as.numeric(ifelse(grepl("Oceanian", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(Palearctic = as.numeric(ifelse(grepl("Palearctic", realm, ignore.case = TRUE),'1','0'))) %>%
  mutate(cosmopolitanness = rowSums(.[24:31])) %>%
  mutate(across(cosmopolitanness, ~ na_if(., 0)))

realmsplot <- realms %>%
  group_by(DroughtDataAvailable) %>%
  summarise(across(23:30, ~ sum(.x, na.rm = TRUE))) %>%
  pivot_longer(cols = `Afrotropical`:`Palearctic`, names_to = "realm", values_to = "totalspecies") %>%
  ggplot(aes(x = realm, y=totalspecies, fill = DroughtDataAvailable)) +
  geom_bar(position= "dodge", stat= "identity") +
  scale_fill_manual(name = "DroughtDataAvailable", values = c("#7D5D3A", "#53619E")) +
  scale_y_log10() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Total Count of Species that possibly fall into realm (log10)", x = "IUCN Biogeographic Realm") +
  guides(fill=guide_legend("Drought Data Availability"))
plot(realmsplot)

cosmopolitannessplot <- ggplot(data =realms, aes(as.factor(cosmopolitanness), fill = DroughtDataAvailable)) +
  geom_bar(position= "dodge") +
  scale_fill_manual(name = "DroughtDataAvailable", values = c("#7D5D3A", "#53619E")) +
  scale_y_log10() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Species Count (log10 transformed)", x = "Total Number of IUCN Biogeographic Realms a species occcurs in") +
  guides(fill=guide_legend("Drought Data Availability"))
plot(cosmopolitannessplot)

```

<br>
<br>

Quick download of plant growth form

```{r}
#load in the TRY data that is growth form (four different types of data)
growthform <- fread("Data/32845.txt", fill = TRUE)

#this is a huge dataset with lots of values and is just generally extremely messy - first discovered that the value with most information is the "growth form complete" value

growthformcomplete <- growthform %>%
  filter(OriglName == "growth form complete") %>%
  dplyr::rename(scientificName = SpeciesName)
  
droughtdatawithgrowthform1 <- left_join(droughtdata, growthformcomplete, by = "scientificName") %>%
  select(1:10, OrigValueStr, Reference) %>%
  dplyr::rename(GrowthForm = OrigValueStr) %>%
  dplyr::rename(ReferenceforGrowthForm = Reference) %>%
  distinct(scientificName, .keep_all = TRUE)

#this data gives us around 50% of all species growth forms in our drought dataset

#now to try and fill in the gaps here - run the same thing with other growth-form metrics

#take just the species that haven't been covered by that dataset

growthformnotcovered1 <- droughtdatawithgrowthform1 %>%
  filter(is.na(GrowthForm))

#left_join this with some growth form data - pull anything called growth form from TRY

growthformany <- growthform %>%
  dplyr::rename(scientificName = SpeciesName) %>%
  filter(str_detect(OriglName, "(?i)growth form|(?i)growthform|(?i)growth_form")) %>%
  filter(OriglName != "growth form complete") #remove growth forms that are already accounted for

#join this back with previous data to just have info for our speceies

droughtdatawithgrowthform2 <- left_join(growthformnotcovered1, growthformany, by = "scientificName") %>%
  select(1:10, OrigValueStr, Reference) %>%
  dplyr::rename(GrowthForm = OrigValueStr) %>%
  dplyr::rename(ReferenceforGrowthForm = Reference) %>%
  distinct(scientificName, .keep_all = TRUE)

growthformnotcovered2 <- droughtdatawithgrowthform2 %>%
  filter(is.na(GrowthForm))  

## covered around 2000 more species but we still have 2000 with missing data

#try other data types e.g. "habit"

habit <- growthform %>%
  dplyr::rename(scientificName = SpeciesName) %>%
  filter(str_detect(OriglName, "(?i)habit")) %>%
  filter(!str_detect(OriglName, "(?i)habitat|(?i)microhabit")) #trying species habit but not habitat or microhabitat

droughtdatawithgrowthform3 <- left_join(growthformnotcovered2, habit, by = "scientificName") %>%
  select(1:10, OrigValueStr, Reference) %>%
  dplyr::rename(GrowthForm = OrigValueStr) %>%
  dplyr::rename(ReferenceforGrowthForm = Reference) %>%
  distinct(scientificName, .keep_all = TRUE)

growthformnotcovered3 <- droughtdatawithgrowthform3 %>%
  filter(is.na(GrowthForm))  

#plant habit covered literally one single species in our list - still a lot to go

# try "life form" or "plant form" or 

formvague <- growthform %>%
  dplyr::rename(scientificName = SpeciesName) %>%
  filter(str_detect(OriglName, "(?i)L-form|(?i)life form|(?i)life_form|(?i)life stage|(?i)main_growth_form|(?i)plant form|(?i)SpeciesLifeForm"))

droughtdatawithgrowthform4 <- left_join(growthformnotcovered3, formvague, by = "scientificName") %>%
  select(1:10, OrigValueStr, Reference) %>%
  dplyr::rename(GrowthForm = OrigValueStr) %>%
  dplyr::rename(ReferenceforGrowthForm = Reference) %>%
  distinct(scientificName, .keep_all = TRUE)

growthformnotcovered4 <- droughtdatawithgrowthform4 %>%
  filter(is.na(GrowthForm))  

##and life form gave us four more species... still going...

#tried a whole bunch of others but clear that out species aren't necessarily covered for their growth form in this TRY data

# so now just checking what realms these remaining species that we don't know the growth form of are

# merge all that info back together



df_list <- list(filter(droughtdatawithgrowthform1, !is.na(GrowthForm)),
                filter(droughtdatawithgrowthform2, !is.na(GrowthForm)), 
                filter(droughtdatawithgrowthform3, !is.na(GrowthForm)),
                filter(droughtdatawithgrowthform4, !is.na(GrowthForm)),
                growthformnotcovered4)

fulldroughtandgrowthform <- df_list %>%
  reduce(full_join, by=c('scientificName', 'duration_min', 'duration_max', 'duration_mean', 'duration_stdev', 'frequency_min', 'frequency_max', 'frequency_mean', 'frequency_stdev', 'eoo_km2', 'GrowthForm', 'ReferenceforGrowthForm'))

# now put this back with IUCN habitat types and see the spread of species left that don't have growth form data on TRY

fullDroughtIUCNgrowthformdata <- left_join(fulldroughtandgrowthform, fullDroughtIUCNdata, by = "scientificName") %>%
  mutate(Aquatic = ifelse(grepl("aqua|float", GrowthForm, ignore.case = TRUE),'yes',
                          ifelse(systems == "Freshwater (=Inland waters)" | systems == "Marine" & is.na(GrowthForm), 'yes', 
                                 'no'))) #make a column for if the species is aquatic or not

#great now we can remove the plants that are specifically "aquatic" using these methods
```


